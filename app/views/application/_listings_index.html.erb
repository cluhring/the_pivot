<div class="wrapper">
<button id="aa" class="btn btn-default">Close Map</button>
</div>
<div class="row listings-index">
  <div closs= "row">
    <div class="col-lg-6">
      <ul class="slides">
        <% listings.each do |listing| %>
          <li class="listing-slide" id="listing-slide">
          <div class="listing">
            <%= link_to user_listing_path(listing.user.slug, listing) do %>
              <% if listing.listing_images.any? %>
                <%= image_tag listing.listing_images.first.image.url %>
              <% end %>
              <span class="d-hover"><br>
                <%= listing.description %><br>
                <%= listing.category.name %><br>
                Nightly Rate <%= number_to_currency(listing.currency) %><br>
                Sleep <%= listing.max_guests %><br>
              </span>
            </a>
            <div class="text-listing-index">
              <div class="text-listing-title">
                <p><%= link_to listing.title.upcase, user_listing_path(listing.user.slug, listing) %></p>
              </div>
              <div class="text-listing-city">
                <p><%= listing.city %></p>
              </div>
            </div>
          </div>
          </li>
        <% end %>
      <% end %>
      </ul>
      </div>
    </div>
      <div id='map' class="mappy container"></div>
      <script>
      L.mapbox.accessToken = 'pk.eyJ1IjoiY2x1aHJpbmciLCJhIjoiNWF2Z1l6ZyJ9.8peAq7kTQyvXShlVv1K82w';
      var map = L.mapbox.map('map', 'cluhring.lal7c6c3');
      map.locate({setView: true, maxZoom: 11});

      var myLayer = L.mapbox.featureLayer().addTo(map);

      function onLocationFound(e) {
        var radius = e.accuracy / 2;

        L.marker(e.latlng).addTo(map)
        .bindPopup("You are within " + radius + " meters from this point").openPopup();

        L.circle(e.latlng, radius).addTo(map);
      }

      map.on('locationfound', onLocationFound);

      function onLocationError(e) {
        alert(e.message);
      }

      var geojsonFeatures = [
        <% listings.each do |listing| %>
          {
          "type": "Feature",
          "properties": {
            "url":"<%= request.env['HTTP_HOST']%>/<%= listing.user.slug %>/listings/<%= listing.id %>",
            "marker-symbol":"warehouse",
            "marker-size":"medium",
            "marker-color":"#ff0000",
            "stationDetails": "<%= listing.title %><br><%= listing.full_address %>"
          },
          "geometry": {
            "type": "Point",
            "coordinates": [
              <%= listing.longitude %>,
              <%= listing.latitude %>
              ]
          }
        },
        <% end %>
      ];

      myLayer.on('layeradd', function(e) {
        var marker = e.layer,
          feature = marker.feature;

        var popupContent =  '<a class="popup" href="http://' +
          feature.properties.url + '">' +
          feature.properties.stationDetails + '</a>';
          marker.bindPopup(popupContent);
      });

      myLayer.setGeoJSON(geojsonFeatures);

      map.on('locationerror', onLocationError);

      var denvers = new L.LayerGroup();
      L.marker([39.674216, -104.924942]).bindPopup("Lydia's House").addTo(denvers),
      L.marker([39.6710978, -105.107292]).bindPopup('House on Haunted Hill').addTo(denvers),
      L.marker([39.7934098, -104.863788]).bindPopup('Denver B&B').addTo(denvers);
      L.marker([39.7234098, -104.963788]).bindPopup('Denver Love Shack').addTo(denvers);
      L.marker([39.68234098, -104.503788]).bindPopup('Denver Mountain Retreat').addTo(denvers);

      var newyorks = new L.LayerGroup();
      L.marker([40.624944, -74.131798]).bindPopup('Brooklyn, Brookly, we go hard').addTo(newyorks),
      L.marker([40.7161323, -73.987091]).bindPopup('Manhattan Apt').addTo(newyorks),
      L.marker([40.7771743, -73.959137]).bindPopup('Big Apple Apt').addTo(newyorks);

      var seattles = new L.LayerGroup();
      L.marker([47.614519, -122.326798]).bindPopup('Rain City, USA Condo').addTo(seattles),
      L.marker([47.631634, -122.36908]).bindPopup('Pikes Place Market Bungalo').addTo(seattles),
      L.marker([47.5822069, -122.400668]).bindPopup('Mt Rainier Cabin').addTo(seattles);

      var sanfranciscos = new L.LayerGroup();
      L.marker([37.7702676, -122.423866]).bindPopup('Haight-Ashbury Hostel').addTo(sanfranciscos),
      L.marker([37.7638552, -122.403458]).bindPopup('Golden Gate Escape').addTo(sanfranciscos),
      L.marker([37.738628, -122.47216]).bindPopup('Full House').addTo(sanfranciscos);

      var washingtons = new L.LayerGroup();
      L.marker([38.9149646, -77.095848]).bindPopup('Condo on the Mall').addTo(washingtons),
      L.marker([38.9082124, -77.045082]).bindPopup('Capital Hill House').addTo(washingtons),
      L.marker([38.9126018, -77.059799]).bindPopup('Tidal Basin Retreat').addTo(washingtons),
      L.marker([38.8977332, -77.03653]).bindPopup('Lincoln Bedroom').addTo(washingtons),
      L.marker([38.810551, -77.075218]).bindPopup('Cherry Blossom B&B').addTo(washingtons),
      L.marker([38.896648, -77.025978]).bindPopup('Private Ford Theatre Balcony Suite').addTo(washingtons),
      L.marker([38.893607, -77.014652]).bindPopup('House of Cards').addTo(washingtons),
      L.marker([38.8955911, -77.0317614]).bindPopup('The West Wing').addTo(washingtons);

      var stlouis = new L.LayerGroup();
      L.marker([38.586227, -90.383352]).bindPopup('Gateway to the West').addTo(stlouis),
      L.marker([38.6226441, -90.1928125]).bindPopup('Wizard of Oz House').addTo(stlouis);

      var overlays = {
        "Washington": washingtons,
        "Denver": denvers,
        "New York": newyorks,
        "Seattle": seattles,
        "San Francisco": sanfranciscos,
        "St Louis": stlouis
      };
      L.control.layers(overlays).addTo(map);

    </script>
    <script charset="utf-8">
      $(document).ready(function(){

        $("div.mappy").height( $(".col-lg-6").height() );

        $("#aa").click(function(){
          if($(this).text()==='Close Map'){
            $('div.mappy').hide();
          $('.col-lg-6').animate({width:'100%'},'slow')
            $(this).text('Show Map');
          }else{
            $('div.mappy').show();
          $('.col-lg-6').animate({width: '50%'}, 'slow')
            $(this).text('Close Map');
          }
        });

        $('.leaflet-control-layers-selector').click(function(){
          if($('.leaflet-control-layers-selector').prop('checked') === true)
          map.setView(new L.LatLng(38.92, -77.03), 11)
        })

        // $(this).click(function(){
        //   $(this).prop('checked', true);
        //   // if($(this).prop('checked') === true)
        //   map.setView(new L.LatLng(37.75, -122.42), 10)
        // })
      });
    </script>
    </div>
  </div>
</div>
